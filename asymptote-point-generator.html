<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asymptote Point Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface2: #242836;
            --border: #2e3347;
            --text: #e2e4ed;
            --text-dim: #8b90a5;
            --accent: #6c8aff;
            --accent-glow: rgba(108, 138, 255, 0.25);
            --pink: #f0619a;
            --pink-glow: rgba(240, 97, 154, 0.25);
            --green: #5ce0b8;
            --green-glow: rgba(92, 224, 184, 0.2);
            --orange: #f5a623;
            --orange-glow: rgba(245, 166, 35, 0.2);
            --red: #ef5350;
            --radius: 10px;
            --mono: 'JetBrains Mono', monospace;
            --sans: 'DM Sans', sans-serif;
        }

        body {
            font-family: var(--sans);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
        }

        .app {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--accent), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header .tag {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-dim);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        /* --- Panels --- */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 460px;
            gap: 20px;
            align-items: start;
        }

        @media (max-width: 1100px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .panel-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 0.82rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .panel-body { padding: 16px 18px; }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 7px;
            background: var(--surface2);
            color: var(--text);
            font-family: var(--sans);
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .btn:hover { border-color: var(--accent); background: rgba(108,138,255,0.08); }
        .btn:active { transform: scale(0.97); }

        .btn-accent {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }
        .btn-accent:hover { background: #5a7af0; border-color: #5a7af0; box-shadow: 0 0 16px var(--accent-glow); }

        .btn-pink {
            background: var(--pink);
            border-color: var(--pink);
            color: #fff;
        }
        .btn-pink:hover { background: #d8547f; border-color: #d8547f; box-shadow: 0 0 16px var(--pink-glow); }

        .btn-green {
            background: var(--green);
            border-color: var(--green);
            color: #0f1117;
        }
        .btn-green:hover { background: #4cc9a4; border-color: #4cc9a4; box-shadow: 0 0 16px var(--green-glow); }

        .btn-orange {
            background: var(--orange);
            border-color: var(--orange);
            color: #0f1117;
        }
        .btn-orange:hover { background: #e09520; border-color: #e09520; box-shadow: 0 0 16px var(--orange-glow); }

        .btn-sm { padding: 5px 10px; font-size: 0.75rem; }

        .btn-texer {
            background: linear-gradient(135deg, #4a90d9, #357abd);
            border-color: #357abd;
            color: #fff;
        }
        .btn-texer:hover { background: linear-gradient(135deg, #357abd, #2868a0); border-color: #2868a0; box-shadow: 0 0 16px rgba(74, 144, 217, 0.4); }

        .btn-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        /* --- Image Load Controls --- */
        .load-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .load-row input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 7px;
            color: var(--text);
            font-family: var(--sans);
            font-size: 0.85rem;
        }
        .load-row input[type="text"]:focus { outline: none; border-color: var(--accent); }

        .file-name {
            font-size: 0.78rem;
            color: var(--text-dim);
            margin-left: 4px;
        }

        /* --- Image Container --- */
        .image-wrap {
            position: relative;
            display: none;
            border: 2px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            cursor: crosshair;
            margin-top: 12px;
            background: #000;
            line-height: 0;
        }

        .image-wrap img {
            display: block;
            width: 100%;
            height: auto;
        }

        .dot {
            position: absolute;
            width: 7px;
            height: 7px;
            border-radius: 50%;
            border: 1.5px solid #fff;
            transform: translate(-50%, -50%);
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 0 4px rgba(0,0,0,0.6);
        }

        .dot-label {
            position: absolute;
            left: 10px;
            top: -4px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 9px;
            font-family: var(--mono);
            font-weight: 600;
            white-space: nowrap;
            z-index: 11;
        }

        .coords-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 11px;
            font-family: var(--mono);
            pointer-events: none;
            z-index: 20;
            display: none;
        }

        .magnifier {
            position: absolute;
            width: 140px;
            height: 140px;
            border: 2px solid rgba(255,255,255,0.6);
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            pointer-events: none;
            z-index: 25;
            display: none;
            overflow: hidden;
            background: #000;
        }

        .magnifier canvas {
            position: absolute;
            top: 0; left: 0;
            image-rendering: pixelated;
        }

        .mag-cross {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        .mag-cross::before, .mag-cross::after {
            content: '';
            position: absolute;
            background: rgba(255, 60, 60, 0.7);
        }
        .mag-cross::before {
            width: 1px; height: 18px;
            left: 50%; top: -9px;
            transform: translateX(-50%);
        }
        .mag-cross::after {
            height: 1px; width: 18px;
            top: 50%; left: -9px;
            transform: translateY(-50%);
        }

        /* --- Zoom slider --- */
        .zoom-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .zoom-row label {
            font-size: 0.78rem;
            color: var(--text-dim);
        }
        .zoom-row input[type="range"] {
            width: 120px;
            accent-color: var(--accent);
        }
        .zoom-row span {
            font-family: var(--mono);
            font-size: 0.78rem;
            color: var(--accent);
        }

        /* --- Path info bar --- */
        .path-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.78rem;
            color: var(--text-dim);
        }

        .path-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 600;
            cursor: pointer;
            border: 1.5px solid transparent;
            transition: all 0.15s;
        }
        .path-chip.active {
            border-color: currentColor;
            box-shadow: 0 0 8px currentColor;
        }

        /* --- Code Output --- */
        .code-area {
            width: 100%;
            min-height: 300px;
            background: #0d0f15;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            color: var(--green);
            font-family: var(--mono);
            font-size: 0.8rem;
            line-height: 1.6;
            resize: vertical;
            tab-size: 4;
        }
        .code-area:focus { outline: none; border-color: var(--accent); }

        /* --- AI Chat --- */
        .ai-section { margin-top: 14px; }

        .ai-input-row {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .ai-input {
            flex: 1;
            padding: 10px 14px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 7px;
            color: var(--text);
            font-family: var(--sans);
            font-size: 0.85rem;
            resize: none;
        }
        .ai-input:focus { outline: none; border-color: var(--accent); }
        .ai-input::placeholder { color: var(--text-dim); }

        .ai-btn-col {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ai-status {
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-dim);
            min-height: 1.2em;
        }
        .ai-status.error { color: var(--red); }
        .ai-status .spinner {
            display: inline-block;
            width: 12px; height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Path color palette --- */
        .path-colors {
            --c0: #6c8aff;
            --c1: #f0619a;
            --c2: #5ce0b8;
            --c3: #f5a623;
            --c4: #a78bfa;
            --c5: #f87171;
            --c6: #38bdf8;
            --c7: #fbbf24;
        }

        /* --- Info bar --- */
        .info-bar {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 0.78rem;
            color: var(--text-dim);
            line-height: 1.5;
            margin-bottom: 14px;
        }
        .info-bar kbd, .ai-status kbd {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1px 6px;
            font-family: var(--mono);
            font-size: 0.72rem;
        }
    </style>
</head>
<body>
<div class="app">
    <header>
        <h1>Asymptote Point Generator</h1>
        <span class="tag">Multi-path ¬∑ AI Assist</span>
    </header>

    <div class="main-grid">
        <!-- LEFT COLUMN: Image + Controls -->
        <div>
            <div class="panel">
                <div class="panel-head">
                    Image Source
                </div>
                <div class="panel-body">
                    <div class="load-row">
                        <input type="text" id="urlInput" placeholder="Paste image URL (CORS-enabled)‚Ä¶">
                        <button class="btn" onclick="loadImage()">Load URL</button>
                    </div>
                    <div class="load-row">
                        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="loadLocalImage(event)">
                        <button class="btn btn-accent" onclick="document.getElementById('fileInput').click()">üìÅ File</button>
                        <button class="btn" onclick="loadFromClipboard()" style="border-color:var(--green);color:var(--green)">üìã Clipboard</button>
                        <span class="file-name" id="fileName"></span>
                    </div>

                    <div class="info-bar">
                        Click the image to add points. <kbd>Ctrl+Z</kbd> to undo. <kbd>Ctrl+V</kbd> to paste an image.
                    </div>

                    <div class="btn-row">
                        <button class="btn btn-green" onclick="newPath()">Ôºã New Path</button>
                        <button class="btn" onclick="undoLastPoint()">‚Ü© Undo</button>
                        <button class="btn btn-pink" onclick="clearAll()">‚úï Clear All</button>
                    </div>

                    <div class="zoom-row">
                        <label>Magnifier:</label>
                        <input type="range" id="zoomLevel" min="2" max="10" value="5" step="0.5">
                        <span id="zoomValue">5√ó</span>
                    </div>

                    <div class="path-bar" id="pathBar"></div>

                    <div class="image-wrap" id="imageContainer">
                        <img id="image" alt="">
                        <div class="coords-tooltip" id="coordinates"></div>
                        <div class="magnifier" id="magnifier">
                            <canvas id="magnifierCanvas"></canvas>
                            <div class="mag-cross"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Code + AI -->
        <div>
            <div class="panel">
                <div class="panel-head">
                    Asymptote Code
                    <button class="btn btn-sm" onclick="copyCode()">üìã Copy</button>
                </div>
                <div class="panel-body" style="padding:0;">
                    <textarea class="code-area" id="codeArea" spellcheck="false" placeholder="Click on the image to add points‚Ä¶"></textarea>
                </div>
            </div>

            <div class="panel" style="margin-top:14px;">
                <div class="panel-head">Send to TeXeR</div>
                <div class="panel-body">
                    <div class="load-row">
                        <input type="text" id="texerSlug" placeholder="Optional: texer slug (e.g. flashlight)">
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-texer" onclick="sendToTexer()">üöÄ Send to TeXeR</button>
                    </div>
                    <div class="ai-status" id="texerStatus"></div>
                </div>
            </div>

            <div class="panel" style="margin-top:14px;">
                <div class="panel-head">AI Assist</div>
                <div class="panel-body">
                    <div class="ai-section">
                        <div class="load-row" style="margin-bottom:10px;">
                            <input type="password" id="apiKey" placeholder="Anthropic API key (stored locally)" style="flex:1;min-width:200px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--sans);font-size:0.85rem;">
                        </div>
                        <textarea class="ai-input" id="aiInput" rows="3" placeholder="e.g. &quot;Change connectors from .. to --&quot; or &quot;Remove the cycle on path 2&quot;"></textarea>
                        <div class="ai-input-row" style="margin-top:8px;">
                            <button class="btn btn-orange" onclick="askAI('haiku')" id="btnHaiku">‚ö° Haiku <span style="font-weight:400;opacity:0.7">(fast)</span></button>
                            <button class="btn btn-accent" onclick="askAI('opus')" id="btnOpus">üß† Opus 4.6 <span style="font-weight:400;opacity:0.7">(deep)</span></button>
                        </div>
                        <div class="ai-status" id="aiStatus"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let paths = [[]];          // array of arrays of {x, y, pixelX, pixelY, label}
let currentPath = 0;
let imageWidth = 0;
let imageHeight = 0;
let zoomLevel = 5;
let magnifierCanvas, magnifierCtx;
let globalLabelIndex = 0;

const PATH_COLORS = ['#6c8aff','#f0619a','#5ce0b8','#f5a623','#a78bfa','#f87171','#38bdf8','#fbbf24'];

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
window.onload = function() {
    magnifierCanvas = document.getElementById('magnifierCanvas');
    magnifierCtx = magnifierCanvas.getContext('2d');
    magnifierCanvas.width = 560;
    magnifierCanvas.height = 560;

    document.getElementById('zoomLevel').addEventListener('input', e => {
        zoomLevel = parseFloat(e.target.value);
        document.getElementById('zoomValue').textContent = zoomLevel + '√ó';
    });

    updatePathBar();
};

// ‚îÄ‚îÄ Labels ‚îÄ‚îÄ
function getLetterLabel(index) {
    if (index < 26) return String.fromCharCode(65 + index);
    return String.fromCharCode(65 + Math.floor(index / 26) - 1) + String.fromCharCode(65 + (index % 26));
}

// ‚îÄ‚îÄ Image Loading ‚îÄ‚îÄ
function showImage(imgEl) {
    imageWidth = imgEl.naturalWidth;
    imageHeight = imgEl.naturalHeight;
    document.getElementById('imageContainer').style.display = 'block';
    clearAll();
}

function loadImage() {
    const url = document.getElementById('urlInput').value.trim();
    if (!url) return alert('Enter an image URL');
    const img = document.getElementById('image');
    img.onload = function() { showImage(this); };
    img.onerror = () => alert('Failed to load image.');
    img.src = url;
}

function loadLocalImage(event) {
    const file = event.target.files[0];
    if (!file || !file.type.startsWith('image/')) return;
    document.getElementById('fileName').textContent = file.name;
    const reader = new FileReader();
    const img = document.getElementById('image');
    reader.onload = e => {
        img.onload = function() { showImage(this); };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

async function loadFromClipboard() {
    try {
        const items = await navigator.clipboard.read();
        for (const item of items) {
            for (const type of item.types) {
                if (type.startsWith('image/')) {
                    const blob = await item.getType(type);
                    const reader = new FileReader();
                    const img = document.getElementById('image');
                    document.getElementById('fileName').textContent = 'Clipboard';
                    reader.onload = e => {
                        img.onload = function() { showImage(this); };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(blob);
                    return;
                }
            }
        }
        alert('No image in clipboard.');
    } catch (err) {
        alert('Clipboard access denied or no image found.');
    }
}

// ‚îÄ‚îÄ Points & Paths ‚îÄ‚îÄ
function newPath() {
    // Only add new path if current path has points
    if (paths[currentPath].length === 0 && paths.length > 0) return;
    paths.push([]);
    currentPath = paths.length - 1;
    updatePathBar();
    updateOutput();
}

function switchPath(idx) {
    currentPath = idx;
    updatePathBar();
}

function updatePathBar() {
    const bar = document.getElementById('pathBar');
    if (paths.length <= 1 && paths[0].length === 0) {
        bar.innerHTML = '';
        return;
    }
    bar.innerHTML = paths.map((p, i) => {
        const c = PATH_COLORS[i % PATH_COLORS.length];
        const active = i === currentPath ? 'active' : '';
        return `<span class="path-chip ${active}" style="color:${c};background:${c}18" onclick="switchPath(${i})">Path ${i+1} (${p.length} pts)</span>`;
    }).join('');
}

// Click handler
document.getElementById('imageContainer').addEventListener('click', function(e) {
    const img = document.getElementById('image');
    if (e.target !== img) return;

    const rect = img.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const normalizedX = x / img.offsetWidth;
    const normalizedY = 1 - (y / img.offsetHeight);

    const label = getLetterLabel(globalLabelIndex++);

    paths[currentPath].push({ x: normalizedX, y: normalizedY, pixelX: x, pixelY: y, label });

    // Visual dot
    const dot = document.createElement('div');
    dot.className = 'dot';
    dot.style.left = x + 'px';
    dot.style.top = y + 'px';
    dot.style.background = PATH_COLORS[currentPath % PATH_COLORS.length];
    dot.dataset.path = currentPath;
    dot.dataset.idx = paths[currentPath].length - 1;

    const lbl = document.createElement('div');
    lbl.className = 'dot-label';
    lbl.textContent = label;
    dot.appendChild(lbl);

    this.appendChild(dot);
    updatePathBar();
    updateOutput();
});

// Mouse-move: coords + magnifier
document.getElementById('imageContainer').addEventListener('mousemove', function(e) {
    const img = document.getElementById('image');
    if (e.target !== img && !e.target.closest('.image-wrap')) return;
    const rect = img.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    if (x < 0 || y < 0 || x > img.offsetWidth || y > img.offsetHeight) return;

    const nx = (x / img.offsetWidth).toFixed(3);
    const ny = (1 - y / img.offsetHeight).toFixed(3);

    const coords = document.getElementById('coordinates');
    coords.style.display = 'block';
    coords.style.left = (x + 12) + 'px';
    coords.style.top = (y - 28) + 'px';
    coords.textContent = `(${nx}, ${ny})`;

    const mag = document.getElementById('magnifier');
    mag.style.display = 'block';
    let mx = x + 25, my = y - 170;
    if (mx + 140 > img.offsetWidth) mx = x - 165;
    if (my < 0) my = y + 25;
    mag.style.left = mx + 'px';
    mag.style.top = my + 'px';

    if (magnifierCtx && img.complete) {
        const srcSize = 30 / zoomLevel;
        const sx = (x / img.offsetWidth) * img.naturalWidth - srcSize / 2;
        const sy = (y / img.offsetHeight) * img.naturalHeight - srcSize / 2;
        magnifierCtx.imageSmoothingEnabled = false;
        magnifierCtx.clearRect(0, 0, 560, 560);
        magnifierCtx.drawImage(img, sx, sy, srcSize, srcSize, 0, 0, 560, 560);
    }
});

document.getElementById('imageContainer').addEventListener('mouseleave', function() {
    document.getElementById('coordinates').style.display = 'none';
    document.getElementById('magnifier').style.display = 'none';
});

// ‚îÄ‚îÄ Code Generation ‚îÄ‚îÄ
function generateCode() {
    let code = '[asy]\n';

    // Size command preserving aspect ratio
    if (imageWidth && imageHeight) {
        const maxDim = 200;
        const scale = maxDim / Math.max(imageWidth, imageHeight);
        const w = +(imageWidth * scale).toFixed(1);
        const h = +(imageHeight * scale).toFixed(1);
        code += `size(${w}, ${h}, IgnoreAspect);\n\n`;
    }

    const pathNames = [];
    let hasPoints = false;

    paths.forEach((pts, pi) => {
        if (pts.length === 0) return;
        hasPoints = true;
        const pName = paths.length === 1 ? 'shape' : `p${pi + 1}`;
        pathNames.push(pName);

        code += `// Path ${pi + 1}\n`;
        pts.forEach(pt => {
            code += `pair ${pt.label} = (${pt.x.toFixed(3)}, ${pt.y.toFixed(3)});\n`;
        });

        if (pts.length >= 2) {
            code += `path ${pName} = ${pts.map(p => p.label).join('..')}..cycle;\n`;
        } else if (pts.length === 1) {
            code += `// (need ‚â•2 points for a path)\n`;
        }
        code += '\n';
    });

    // Concatenate paths with ^^ if multiple
    if (pathNames.length > 1) {
        code += `path shape = ${pathNames.join(' ^^ ')};\n\n`;
    }

    // Draw command
    if (pathNames.length >= 1) {
        code += `draw(shape);\n`;
    }

    code += '[/asy]';
    return code;
}

function updateOutput() {
    document.getElementById('codeArea').value = generateCode();
}

// ‚îÄ‚îÄ Clear / Undo ‚îÄ‚îÄ
function clearAll() {
    paths = [[]];
    currentPath = 0;
    globalLabelIndex = 0;
    document.querySelectorAll('.dot').forEach(d => d.remove());
    updatePathBar();
    updateOutput();
}

function undoLastPoint() {
    // Find the last non-empty path
    let pi = currentPath;
    if (paths[pi].length === 0) {
        // try previous paths
        for (let i = paths.length - 1; i >= 0; i--) {
            if (paths[i].length > 0) { pi = i; break; }
        }
    }
    if (paths[pi].length === 0) return;

    paths[pi].pop();
    globalLabelIndex = Math.max(0, globalLabelIndex - 1);

    // Remove visual dot
    const dots = document.querySelectorAll(`.dot[data-path="${pi}"]`);
    if (dots.length > 0) dots[dots.length - 1].remove();

    // Remove empty trailing paths (but keep at least one)
    while (paths.length > 1 && paths[paths.length - 1].length === 0) {
        paths.pop();
    }
    currentPath = paths.length - 1;

    updatePathBar();
    updateOutput();
}

function copyCode() {
    const code = document.getElementById('codeArea').value;
    if (!code) return alert('No code to copy.');
    navigator.clipboard.writeText(code).then(() => {
        const btn = document.querySelector('.panel-head .btn-sm');
        const orig = btn.textContent;
        btn.textContent = '‚úì Copied';
        setTimeout(() => btn.textContent = orig, 1200);
    });
}

// ‚îÄ‚îÄ Send to TeXeR ‚îÄ‚îÄ
function sendToTexer() {
    const code = document.getElementById('codeArea').value;
    if (!code || code.trim() === '[asy]\n[/asy]') {
        alert('No code to send. Add some points first.');
        return;
    }

    const slug = document.getElementById('texerSlug').value.trim();
    const baseUrl = 'https://artofproblemsolving.com/texer';
    const texerUrl = slug ? `${baseUrl}/${slug}` : baseUrl;

    const status = document.getElementById('texerStatus');

    // Copy code to clipboard
    navigator.clipboard.writeText(code).then(() => {
        // Open TeXeR in new tab
        const newTab = window.open(texerUrl, '_blank');

        if (newTab) {
            status.className = 'ai-status';
            status.innerHTML = '‚úì Code copied! In TeXeR: <kbd>Ctrl+V</kbd> to paste, then click <strong>BBCode</strong> to render.';
        } else {
            status.className = 'ai-status error';
            status.textContent = '‚úï Popup blocked. Allow popups and try again.';
        }
    }).catch(err => {
        status.className = 'ai-status error';
        status.textContent = '‚úï Failed to copy: ' + err.message;
    });
}

// ‚îÄ‚îÄ AI Assist ‚îÄ‚îÄ
// Load saved API key on init
window.addEventListener('DOMContentLoaded', () => {
    const savedKey = localStorage.getItem('anthropic_api_key');
    if (savedKey) document.getElementById('apiKey').value = savedKey;
});

async function askAI(tier) {
    const input = document.getElementById('aiInput').value.trim();
    if (!input) return;

    const apiKey = document.getElementById('apiKey').value.trim();
    if (!apiKey) {
        document.getElementById('aiStatus').className = 'ai-status error';
        document.getElementById('aiStatus').textContent = '‚úï Please enter your Anthropic API key.';
        return;
    }
    // Save API key to localStorage
    localStorage.setItem('anthropic_api_key', apiKey);

    const currentCode = document.getElementById('codeArea').value;
    const status = document.getElementById('aiStatus');
    const btnH = document.getElementById('btnHaiku');
    const btnO = document.getElementById('btnOpus');

    const model = tier === 'haiku' ? 'claude-haiku-4-5-20251001' : 'claude-opus-4-6';
    const label = tier === 'haiku' ? 'Haiku' : 'Opus 4.6';

    btnH.disabled = true; btnO.disabled = true;
    status.className = 'ai-status';
    status.innerHTML = `<span class="spinner"></span> Asking ${label}‚Ä¶`;

    try {
        const resp = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model,
                max_tokens: 4096,
                system: `You are an Asymptote code editor. The user will give you Asymptote code wrapped in [asy]...[/asy] tags and a change request. Return ONLY the modified complete Asymptote code including the [asy] and [/asy] tags. No explanation, no markdown fences, no extra text‚Äîjust the code. Preserve all existing structure unless the user asks to change it. The code uses normalized 0-1 coordinates with a size() command for aspect ratio.`,
                messages: [
                    {
                        role: 'user',
                        content: `Here is my current Asymptote code:\n\n${currentCode}\n\nPlease make this change: ${input}`
                    }
                ]
            })
        });

        const data = await resp.json();

        if (data.error) {
            throw new Error(data.error.message || 'API error');
        }

        const text = data.content.map(b => b.text || '').join('');
        // Extract just the code (should already be clean, but strip markdown fences if present)
        let cleaned = text.replace(/```[\w]*\n?/g, '').replace(/```$/g, '').trim();
        document.getElementById('codeArea').value = cleaned;

        status.className = 'ai-status';
        status.textContent = `‚úì ${label} applied changes.`;
    } catch (err) {
        status.className = 'ai-status error';
        status.textContent = `‚úï Error: ${err.message}`;
    } finally {
        btnH.disabled = false;
        btnO.disabled = false;
    }
}

// ‚îÄ‚îÄ Keyboard Shortcuts ‚îÄ‚îÄ
document.addEventListener('keydown', function(e) {
    // Ctrl+Z undo (only if not in text fields)
    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) {
        e.preventDefault();
        undoLastPoint();
    }
    // Ctrl+V paste
    if ((e.ctrlKey || e.metaKey) && e.key === 'v' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) {
        e.preventDefault();
        loadFromClipboard();
    }
});

document.getElementById('urlInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') loadImage();
});

// Send AI request on Enter in AI input (but allow Shift+Enter for newlines)
document.getElementById('aiInput').addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        askAI('haiku'); // default to fast
    }
});
</script>
</body>
</html>
